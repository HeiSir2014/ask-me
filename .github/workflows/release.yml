name: Release

on:
  push:
    # å½“æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘ï¼Œä¾‹å¦‚ v1.0.0
    tags:
      - 'v*'

env:
  # ä½¿ç”¨ Bun çš„æœ€æ–°ç‰ˆæœ¬
  BUN_VERSION: 'latest'

jobs:
  # æ„å»ºä½œä¸š - çŸ©é˜µç­–ç•¥æ”¯æŒå¤šå¹³å°
  build:
    name: Build ${{ matrix.platform }}

    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        include:
          # Windows x64
          - platform: 'windows-x64'
            os: 'windows-latest'
            artifact_name: 'ask-me-windows-x64.exe'

          # Linux x64
          - platform: 'linux-x64'
            os: 'ubuntu-latest'
            artifact_name: 'ask-me-linux-x64'

          # macOS Intel (x64)
          - platform: 'macos-x64'
            os: 'macos-latest'
            artifact_name: 'ask-me-macos-x64'

          # macOS Apple Silicon (arm64)
          - platform: 'macos-arm64'
            os: 'macos-latest'
            artifact_name: 'ask-me-macos-arm64'

    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # è®¾ç½® Bun
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      # å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: bun install --frozen-lockfile

      # ç¼–è¯‘æŒ‡å®šå¹³å°
      - name: Build for ${{ matrix.platform }}
        run: |
          case ${{ matrix.platform }} in
            windows-x64)
              bun run compile:windows
              ;;
            linux-x64)
              bun run compile:linux
              ;;
            macos-x64)
              bun run compile:macos:x64
              ;;
            macos-arm64)
              bun run compile:macos:arm64
              ;;
          esac

      # ä¸Šä¼ ç¼–è¯‘äº§ç‰©
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            dist/${{ matrix.platform }}/*
          retention-days: 30

      # æ˜¾ç¤ºç¼–è¯‘ç»“æœ
      - name: Show build output
        run: |
          echo "âœ… Build completed for ${{ matrix.platform }}"
          ls -lah dist/${{ matrix.platform }}/
          if [ -f "dist/${{ matrix.platform }}/ask-me" ]; then
            echo "ğŸ“„ File info:"
            file "dist/${{ matrix.platform }}/ask-me"
            echo "ğŸ“ Size:"
            du -h "dist/${{ matrix.platform }}/ask-me"
          fi
          if [ -f "dist/${{ matrix.platform }}/ask-me.exe" ]; then
            echo "ğŸ“„ File info:"
            file "dist/${{ matrix.platform }}/ask-me.exe"
            echo "ğŸ“ Size:"
            du -h "dist/${{ matrix.platform }}/ask-me.exe"
          fi

  # å‘å¸ƒä½œä¸š
  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      attestations: write
      id-token: write

    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # ä¸‹è½½æ‰€æœ‰ç¼–è¯‘äº§ç‰©
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      # åˆ—å‡ºä¸‹è½½çš„æ–‡ä»¶
      - name: List downloaded artifacts
        run: |
          echo "ğŸ“¦ Downloaded artifacts:"
          find ./artifacts -type f -exec ls -lah {} \;

      # ä½¿ç”¨ softprops/action-gh-release åˆ›å»º Release
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Ask-Me CLI ${{ github.ref_name }}
          body: |
            ## ğŸ‰ Ask-Me CLI ${{ github.ref_name }}

            Interactive prompt tool for Cursor AI - continuous work loop

            ### ğŸ“¦ Download Binaries

            | Platform | Architecture | Download |
            |----------|--------------|----------|
            | Windows  | x64          | [ask-me-windows-x64.exe](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/ask-me-windows-x64.exe) |
            | Linux    | x64          | [ask-me-linux-x64](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/ask-me-linux-x64) |
            | macOS    | Intel (x64)  | [ask-me-macos-x64](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/ask-me-macos-x64) |
            | macOS    | Apple Silicon (arm64) | [ask-me-macos-arm64](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/ask-me-macos-arm64) |

            ### ğŸš€ Quick Install

            ```bash
            # macOS/Linux
            curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}/scripts/install.sh | bash

            # Windows (PowerShell as Administrator)
            iwr -useb https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/ask-me-windows-x64.exe | iex
            ```

            ### âœ¨ Features

            - ğŸ”„ Continuous work loop - Cursor AI interacts via ask-me
            - ğŸ“ Markdown history - Archive sessions by project and date
            - âœï¸ Multi-editor support - 15+ editors (VSCode, Cursor, Zed, Vim, etc.)
            - ğŸ¯ Jump to line - Auto-focus input area
            - â±ï¸ Timeout reminders - Friendly alert after 4 minutes
            - ğŸ” First-run experience - Auto-detect editor
            - âœ… Config validation - Using Zod for settings validation

            ### ğŸ“š Usage

            ```bash
            # Install and link
            bun install && bun link

            # Run directly
            ask-me --cwd="/path/to/project" --title="Task done"

            # Or use short alias
            ask --title="Quick update"

            # Install compiled binary
            ./dist/macos-x64/ask-me install
            ```

            ### ğŸ”§ Build from Source

            ```bash
            git clone https://github.com/${{ github.repository }}.git
            cd ask-me
            bun install
            bun run compile
            ```

            ---
            Built with â¤ï¸ using Bun + TypeScript

          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            ./artifacts/ask-me-windows-x64/ask-me.exe
            ./artifacts/ask-me-linux-x64/ask-me
            ./artifacts/ask-me-macos-x64/ask-me
            ./artifacts/ask-me-macos-arm64/ask-me

      # éªŒè¯ Release
      - name: Verify Release
        run: |
          echo "âœ… Release created successfully!"
          echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
