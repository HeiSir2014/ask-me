name: Release

on:
  push:
    # å½“æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘ï¼Œä¾‹å¦‚ v1.0.0
    tags:
      - 'v*'

env:
  # ä½¿ç”¨ Bun çš„æœ€æ–°ç‰ˆæœ¬
  BUN_VERSION: 'latest'

jobs:
  # æ„å»ºä½œä¸š - çŸ©é˜µç­–ç•¥æ”¯æŒå¤šå¹³å°
  build:
    name: Build ${{ matrix.platform }}

    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        include:
          # Windows x64
          - platform: 'windows-x64'
            os: 'windows-latest'
            artifact_name: 'ask-me-windows-x64'

          # Linux x64
          - platform: 'linux-x64'
            os: 'ubuntu-latest'
            artifact_name: 'ask-me-linux-x64'

          # macOS Intel (x64)
          - platform: 'macos-x64'
            os: 'macos-latest'
            artifact_name: 'ask-me-macos-x64'

          # macOS Apple Silicon (arm64)
          - platform: 'macos-arm64'
            os: 'macos-latest'
            artifact_name: 'ask-me-macos-arm64'

    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # è®¾ç½® Bun
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      # å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: bun install --frozen-lockfile

      # ç¼–è¯‘æŒ‡å®šå¹³å°
      - name: Build for ${{ matrix.platform }}
        shell: bash
        run: |
          if [ "${{ matrix.platform }}" = "windows-x64" ]; then
            bun run compile:windows
          elif [ "${{ matrix.platform }}" = "linux-x64" ]; then
            bun run compile:linux
          elif [ "${{ matrix.platform }}" = "macos-x64" ]; then
            bun run compile:macos:x64
          elif [ "${{ matrix.platform }}" = "macos-arm64" ]; then
            bun run compile:macos:arm64
          fi

      # é‡å‘½åå¹¶ä¸Šä¼ ç¼–è¯‘äº§ç‰©
      - name: Rename and upload build artifact
        shell: bash
        run: |
          mkdir -p ./release
          if [ "${{ matrix.platform }}" = "windows-x64" ]; then
            cp dist/${{ matrix.platform }}/ask-me.exe ./release/ask-me-windows-x64.exe
          else
            cp dist/${{ matrix.platform }}/ask-me ./release/ask-me-${{ matrix.platform }}
            chmod +x ./release/ask-me-${{ matrix.platform }}
          fi

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ./release/*
          retention-days: 30

      # æ˜¾ç¤ºç¼–è¯‘ç»“æœ
      - name: Show build output
        shell: bash
        run: |
          echo "âœ… Build completed for ${{ matrix.platform }}"
          ls -lah dist/${{ matrix.platform }}/
          if [ -f "dist/${{ matrix.platform }}/ask-me" ]; then
            echo "ğŸ“„ File info:"
            file "dist/${{ matrix.platform }}/ask-me"
            echo "ğŸ“ Size:"
            du -h "dist/${{ matrix.platform }}/ask-me"
          fi
          if [ -f "dist/${{ matrix.platform }}/ask-me.exe" ]; then
            echo "ğŸ“„ File info:"
            file "dist/${{ matrix.platform }}/ask-me.exe"
            echo "ğŸ“ Size:"
            du -h "dist/${{ matrix.platform }}/ask-me.exe"
          fi

  # å‘å¸ƒä½œä¸š
  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      attestations: write
      id-token: write

    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # ä¸‹è½½æ‰€æœ‰ç¼–è¯‘äº§ç‰©
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      # åˆå¹¶æ‰€æœ‰æ–‡ä»¶åˆ°ä¸€ä¸ªç›®å½•
      - name: Prepare release files
        run: |
          mkdir -p ./release
          find ./artifacts -type f -exec cp {} ./release/ \;
          chmod +x ./release/ask-me-* 2>/dev/null || true
          echo "ğŸ“¦ Release files:"
          ls -lah ./release/

      # ä½¿ç”¨ softprops/action-gh-release åˆ›å»º Release
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Ask-Me CLI ${{ github.ref_name }}
          body: |
            ## ğŸ‰ Ask-Me CLI ${{ github.ref_name }}

            Interactive prompt tool for Cursor AI - continuous work loop

            ---

            **ğŸ“– Documentation Languages:**

            - **English Version**: This document
            - **ä¸­æ–‡ç‰ˆ** (Chinese): [README.md](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/README.md)

            ---

            ### ğŸ“¦ Download Binaries

            | Platform | Architecture | Download |
            |----------|--------------|----------|
            | Windows  | x64          | [ask-me-windows-x64.exe](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/ask-me-windows-x64.exe) |
            | Linux    | x64          | [ask-me-linux-x64](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/ask-me-linux-x64) |
            | macOS    | Intel (x64)  | [ask-me-macos-x64](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/ask-me-macos-x64) |
            | macOS    | Apple Silicon (arm64) | [ask-me-macos-arm64](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/ask-me-macos-arm64) |

            ### ğŸš€ Quick Install

            ```bash
            # macOS/Linux
            curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}/scripts/install.sh | bash

            # Windows (PowerShell as Administrator)
            iwr -useb https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/ask-me-windows-x64.exe | iex
            ```

            ### âœ¨ Features

            - ğŸ”„ Continuous work loop - Cursor AI interacts via ask-me
            - â¸ï¸ **Smart pause mechanism** - Event-driven control based on Cursor Hooks
            - ğŸª **Native hooks integration** - Monitor 9 Cursor events in real-time
            - ğŸ“Š **Complete audit tracking** - Log all operations with timestamps
            - ğŸ“ Markdown history - Archive sessions by project and date
            - âœï¸ Multi-editor support - 15+ editors (VSCode, Cursor, Zed, Vim, etc.)
            - ğŸ¯ Jump to line - Auto-focus input area
            - â±ï¸ Timeout reminders - Friendly alert after 4 minutes
            - ğŸ” First-run experience - Auto-detect editor
            - âœ… Config validation - Using Zod for settings validation

            ### ğŸ“š Usage

            ```bash
            # Install and link
            bun install && bun link

            # Initialize Cursor rules and hooks (recommended first step)
            # Default: project-level hooks (affects current project only)
            ask-me init

            # For user-level hooks (affects all projects):
            # ask-me init --hooks user

            # Run directly
            ask-me --cwd="/path/to/project" --title="Task done"

            # Or use short alias
            ask --title="Quick update"

            # Install compiled binary
            ./dist/macos-x64/ask-me install

            # ğŸª Hooks Integration (Pause/Resume Control)
            # Initialize hooks for pause functionality
            ask-me init --hooks project   # Project-level (recommended)
            # or
            ask-me init --hooks user     # User-level (all projects)

            # â¸ï¸ Pause AI execution
            ask-me pause

            # Check pause status
            ask-me hooks --status        # Output: paused or running

            # Resume AI execution
            ask-me resume

            # The AI will automatically detect pause state before operations
            # and resume when you provide input via ask-me command
            ```

            ### ğŸª How Hooks Integration Works

            **Smart Configuration Merge**: ask-me automatically preserves your existing hooks and adds pause control with highest priority.

            **Monitored Events**:
            - **Before operations**: `beforeShellExecution`, `beforeMCPExecution`, `beforeReadFile` (pause check)
            - **After operations**: `afterShellExecution`, `afterMCPExecution`, `afterFileEdit`, `afterAgentThought`, `afterAgentResponse` (audit logging)
            - **Control**: `beforeSubmitPrompt` (auto-resume), `stop` (cleanup)

            **Generated hooks.json**:
            ```json
            {
              "hooks": {
                "beforeShellExecution": [
                  { "command": "ask-me hooks" },
                  { "command": "your-existing-hook" }
                ],
                "afterShellExecution": [
                  { "command": "ask-me hooks" }
                ]
              }
            }
            ```

            **Audit Logging**: All operations are logged to `~/.ask-me/projects/{project}/{date}/hooks-audit.jsonl` for complete traceability.

            ### ğŸ”§ Build from Source

            ```bash
            git clone https://github.com/${{ github.repository }}.git
            cd ask-me
            bun install
            bun run compile
            ```

            ---
            Built with â¤ï¸ using Bun + TypeScript

            Special thanks to **Claude** (Anthropic) for intelligent development assistance and code architecture design.

          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            ./release/*

      # éªŒè¯ Release
      - name: Verify Release
        run: |
          echo "âœ… Release created successfully!"
          echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
